<!DOCTYPE html>
<html>
<head>
    <link href="lib/ExtJS_6.0.0/theme-classic-all.css" rel="stylesheet"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/extjs/6.0.0/classic/theme-classic/resources/theme-classic-all.css"
          rel="stylesheet"/>
    <link href="builder.css" rel="stylesheet"/>
    <script type="text/javascript" src="lib/ExtJS_6.0.0/ext-all.js"></script>
    <script type="text/javascript" src="lib/system.js"></script>
    <script type="text/javascript">

         // --------------- Вдохновение получил из источников -----------
         //  https://metanit.com/web/extjs/
         //  https://metanit.com/web/extjs/6.7.php
         //  https://metanit.com/web/extjs/7.8.php
         //  https://www.w3cschool.cn/extjs/extjs_localization.html
         // -------------------------------------------------------------

         var clientHeight = document.documentElement.clientHeight;
         var clientWidth = document.documentElement.clientWidth ;
         var componentListJson = getJsonUrl('component.json');
         var tagInfoList={};
         var structToArr = function( componentListJson,tagInfoList ){
             for(var key in componentListJson){
                 var info = componentListJson[key];
                 var keyRes = info.tagName;
                 if ( (info["property"]) && (info["property"]["cmptype"])) {
                    keyRes+="-"+info["property"]["cmptype"];
                 }
                 if (keyRes === "undefined") continue;
                 if (info["tagName"] === "undefined") continue;
                 tagInfoList[keyRes]={};
                 if (info["property"])  tagInfoList[keyRes]["property"]=info["property"];
                 if (info["propertyVariant"])  tagInfoList[keyRes]["propertyVariant"]=info["propertyVariant"];
                 if (info["text"])  tagInfoList[keyRes]["text"]=info["text"];
                 if (info["tagName"])  tagInfoList[keyRes]["tagName"]=info["tagName"];
                 if (info["innerHtmlToCaption"])  tagInfoList[keyRes]["innerHtmlToCaption"]=info["innerHtmlToCaption"];
                 if (info["innerHTML"])  tagInfoList[keyRes]["innerHTML"]=info["innerHTML"];
                 if (info["parentTag"])  tagInfoList[keyRes]["parentTag"]=info["parentTag"];
                 if (info["class"])  tagInfoList[keyRes]["class"]=info["class"];
                 if (componentListJson[key].children) {
                    structToArr( componentListJson[key].children, tagInfoList );
                 }
             }
         }
         structToArr( componentListJson, tagInfoList );

         Ext.onReady(function() {
            var domHTMLTreeStory = Ext.create('Ext.data.TreeStore', { root: {} });
            var elementListTreeStory = Ext.create('Ext.data.TreeStore', { root: {} });

            var propertyStory = Ext.create('Ext.data.Store', {
                storeId:'propertyStory',
                fields:[
                    { name: 'key', type: 'string' },
                    { name: 'value', type: 'string' },
                ],
                data:[
                    { key: "msft",   value: '2011/04/22' },
                    { key: "goog",   value: '2011/04/22' },
                    { key: "apple",  value: '2011/04/22' },
                    { key: "sencha", value: '2011/04/22' }
                ]
            });

             var toolbar=Ext.create('Ext.toolbar.Toolbar', {
                    dock: 'top',
                    items: [
                        {
                            text : 'Edit',
                            menu: [
                                {text : 'iframe Designer On/Off',
                                 listeners: {
                                        click: function() {
                                            window.iframe_Designer_On_Off()
                                        }
                                    }
                                },
                                { text: 'iframe Scroll On/Off',
                                  listeners: {
                                        click: function() {
                                           window.iframe_Scroll_On_Off();
                                        }
                                    }
                                }
                            ]
                        },{
                            text : 'SaveToClipboard',
                            listeners: {
                                click: function() {
                                    saveWebForm();
                                }
                            }
                        },{
                            text : 'LoadFromClipboard',
                            listeners: {
                                click: function() {
                                    LoadWebForm();
                                }
                            }
                        }
                        ,{
                            text : 'CopyElement',
                            listeners: {
                                click: function() {
                                      if (selectElement == null) return;
                                      var p_prime = selectElement.cloneNode(true);
                                      var left = parseInt( selectElement.style.left );
                                      left+=10;
                                      p_prime.style.left = left+'px';
                                      selectElement.after(p_prime);
                                      selectElement = p_prime;
                                }
                            }
                        }
                        /*
                        ,'->',{
                            xtype    : 'textfield',
                            name     : 'field',
                            emptyText: 'Найти'
                        }
                        */
                    ]
             });

             Ext.create('Ext.Panel', {
                        width: clientWidth,
                        height: clientHeight,
                        padding: 10,
                        layout:'border',
                        items: [{
                                xtype: 'panel',
                                //title: '',
                                html: '<iframe id="TabBody" width="100%" height="100%" ></iframe>',
                                region: 'center',
                                margin: '5 5 5 5',
                                split: true
                            },{
                                xtype: 'panel',
                                region: 'north',
                                width: 350,
                                height: 28,
                                renderTo: Ext.getBody(),
                                dockedItems: [toolbar]
                            },{
                                xtype: 'panel',
                                title: '',
                                html: 'Нижняя панель',
                                region: 'south',
                                height: 80,
                                split: true
                            },{
                                xtype: 'panel',
                                title: ' ',
                                region: 'west',
                                width: 300,
                                split: true,
                                items: [ {
                                               title: 'DOM tree',
                                               region: 'north',
                                               height: 400,
                                               xtype: 'panel',
                                               items:[
                                                       {
                                                            width: 3500,
                                                            xtype: 'textfield',
                                                             id: 'filterDomTreeView',
                                                            name: 'name',
                                                            // allowBlank: false,  // requires a non-empty value
                                                            listeners: {
                                                                specialkey: function(f,e){
                                                                   if (e.getKey() == e.ENTER) {
                                                                      var filterDomTreeView = Ext.getCmp('filterDomTreeView');
                                                                      var srctxt = filterDomTreeView.value.toLowerCase();
                                                                      var domTreeView = Ext.getCmp('domTreeView');
                                                                      var startNode = domTreeView.getRootNode();
                                                                      startNode.cascadeBy(function (childNode) {
                                                                         var node = childNode.get('ObjectElement');
                                                                         if (typeof node === 'undefined') return;
                                                                         if (typeof node['tagName'] === 'undefined') return;
                                                                         function _setSelectItem(){ // локальная функция выбора элемента в дереве
                                                                            var record = domHTMLTreeStory.getNodeById(childNode.id);
                                                                            domTreeView.getSelectionModel().select(record);
                                                                            var path = record.getPath();
                                                                            domTreeView.expandPath(path);
                                                                            viewPropertyInfo(node); // перечитать свойства выбранного элеменита
                                                                         }
                                                                         // поиск по имени компонента
                                                                         if (node.getAttribute("name") != null ){
                                                                             if ( toCamelCase(node.getAttribute("name")).toLowerCase().indexOf(srctxt)!= -1) {
                                                                               _setSelectItem();
                                                                               return false;
                                                                             }
                                                                         }
                                                                         // поиск по имени ТЭГа
                                                                         if(toCamelCase(node['tagName']).toLowerCase().indexOf(srctxt) != -1) {
                                                                               _setSelectItem();
                                                                               return false;
                                                                         }
                                                                      }, this);//5

                                                                   }
                                                                }
                                                            }
                                                       },
                                                       {
                                                       region: 'north',
                                                       height: 400,
                                                       split: true,
                                                        id: 'domTreeView',
                                                       xtype: 'treepanel',
                                                       rootVisible: false,
                                                       autoScroll: true,
                                                       store: domHTMLTreeStory,
                                                       listeners: {
                                                           itemclick : function(tree, record, item, index, e, options) {
                                                               var nodeText = record.data.text;
                                                               clickElement = record.data.ObjectElement;
                                                               selectElement = record.data.ObjectElement;
                                                               if (NewObjectElement == null) {
                                                                  var elementsSrc = TmpElementSrc.querySelectorAll('*');
                                                                  for (var i = 0; i < elementsSrc.length; i++) {
                                                                       if (elementsSrc[i].classList.contains('selectElement')) {
                                                                           elementsSrc[i].classList.remove("selectElement");
                                                                       }
                                                                  }
                                                                  clickElement.classList.add("selectElement");
                                                                  viewPropertyInfo(selectElement); // показать свойства выбранного элемента
                                                               } else {
                                                                  if (testParentTag(clickElement, NewObjectElement ) == false){
                                                                    // alert('Нельзя добавить '+NewObjectElement.tagName+' в родителя '+clickElement.tagName);
                                                                    Ext.Msg.alert('Error!','Нельзя добавить '+toCamelCase(NewObjectElement.tagName.toLowerCase())+' в родителя '+toCamelCase(clickElement.tagName.toLowerCase()));
                                                                    NewObjectElement = null;
                                                                    return;
                                                                  }
                                                                  clickElement.appendChild(NewObjectElement);
                                                                  viewPropertyInfo(NewObjectElement); // показать свойства выбранного элемента
                                                                  selectElement = NewObjectElement;
                                                                  NewObjectElement = null;
                                                                  // перестроить DOM дерево
                                                                  domHTMLTreeStory.getRootNode().removeAll();
                                                                  domHTMLTreeStory.setRootNode(getDOMtree());
                                                                  var domTreeView = Ext.getCmp('domTreeView');
                                                                  var startNode = domTreeView.getRootNode();
                                                                  startNode.cascadeBy(function (childNode) {
                                                                     if (childNode.get('ObjectElement') == selectElement) {
                                                                        var record = domHTMLTreeStory.getNodeById(childNode.id);
                                                                        domTreeView.getSelectionModel().select(record);
                                                                        var path = record.getPath();
                                                                        domTreeView.expandPath(path);
                                                                     }
                                                                  }, this);//5
                                                               }
                                                           },
                                                           itemkeydown:function( tree, record, item, index, e, eOpts ){
                                                               var nodeText = record.data.text;
                                                               clickElement = record.data.ObjectElement;
                                                               if (e.keyCode == 46){ // delete element
                                                                     if (  (selectElement!=null)
                                                                          && (selectElement.tagName!="BODY")
                                                                          && (selectElement.tagName!="HTML")
                                                                          && (selectElement.tagName!="HEAD")
                                                                         ) {
                                                                             var parentEl = selectElement.parentElement;
                                                                             selectElement.remove();
                                                                             selectElement = parentEl;
                                                                             viewPropertyInfo(selectElement); // показать свойства выбранного элемента
                                                                             domHTMLTreeStory.getRootNode().removeAll();
                                                                             domHTMLTreeStory.setRootNode(getDOMtree());
                                                                             var domTreeView = Ext.getCmp('domTreeView');
                                                                             var startNode = domTreeView.getRootNode();
                                                                             startNode.cascadeBy(function (childNode) {
                                                                                 if (childNode.get('ObjectElement') == selectElement) {
                                                                                    var record = domHTMLTreeStory.getNodeById(childNode.id);
                                                                                    domTreeView.getSelectionModel().select(record);
                                                                                    var path = record.getPath();
                                                                                    domTreeView.expandPath(path);
                                                                                 }
                                                                             }, this);
                                                                      }
                                                               }
                                                           },
                                                           itemdblclick : function(tree, record, item, index, e, options) {
                                                               var nodeText = record.data.text;
                                                               clickElement = record.data.ObjectElement;
                                                               selectElement = record.data.ObjectElement;
                                                               dblClickElement();
                                                           },
                                                           itemcontextmenu : function(view, r, node, index, event) {
                                                                event.stopEvent();
                                                                Ext.create('Ext.menu.Menu', {
                                                                    items : [
                                                                        {
                                                                            text : 'Font',
                                                                            menu: [
                                                                                {text : 'delete font-size',iconCls:'deleteIcon', listeners: { click: function(e) {
                                                                                    if (selectElement != null ){ selectElement.style.removeProperty("font-size"); }
                                                                                } } },
                                                                                {text : 'font-size: 8px;',size:"8px",iconCls:'fontIcon', listeners: { click: function(e) {
                                                                                    if (selectElement != null ){  selectElement.style.fontSize = e.config.size; }
                                                                                } } },
                                                                                {text : 'font-size: 10px;',size:"10px",iconCls:'fontIcon', listeners: { click: function(e) {
                                                                                    if (selectElement != null ){  selectElement.style.fontSize = e.config.size; }
                                                                                } } },
                                                                                {text : 'font-size: 12px;',size:"12px",iconCls:'fontIcon', listeners: { click: function(e) {
                                                                                    if (selectElement != null ){  selectElement.style.fontSize = e.config.size; }
                                                                                } } },
                                                                                {text : 'font-size: 14px;',size:"14px",iconCls:'fontIcon', listeners: { click: function(e) {
                                                                                    if (selectElement != null ){  selectElement.style.fontSize = e.config.size; }
                                                                                } } },
                                                                                {text : 'font-size: 16px;',size:"14px",iconCls:'fontIcon', listeners: { click: function(e) {
                                                                                    if (selectElement != null ){  selectElement.style.fontSize = e.config.size; }
                                                                                } } },
                                                                                {text : 'font-size: 18px;',size:"18px",iconCls:'fontIcon', listeners: { click: function(e) {
                                                                                    if (selectElement != null ){  selectElement.style.fontSize = e.config.size; }
                                                                                } } },
                                                                                {text : 'font-size: 20px;',size:"20px",iconCls:'fontIcon', listeners: { click: function(e) {
                                                                                    if (selectElement != null ){  selectElement.style.fontSize = e.config.size; }
                                                                                } } },
                                                                            ]
                                                                        },{
                                                                            text : 'Tree',
                                                                            menu: [
                                                                                {text : 'Обновить дерево',iconCls:'deleteIcon', listeners: { click: function(e) {
                                                                                      domHTMLTreeStory.getRootNode().removeAll();
                                                                                      domHTMLTreeStory.setRootNode(getDOMtree());
                                                                                      var domTreeView = Ext.getCmp('domTreeView');
                                                                                      var startNode = domTreeView.getRootNode();
                                                                                      startNode.cascadeBy(function (childNode) {
                                                                                         if (childNode.get('ObjectElement') == selectElement) {
                                                                                            var record = domHTMLTreeStory.getNodeById(childNode.id);
                                                                                            domTreeView.getSelectionModel().select(record);
                                                                                            var path = record.getPath();
                                                                                            domTreeView.expandPath(path);
                                                                                         }
                                                                                      }, this); // 1
                                                                                } } }
                                                                            ]
                                                                        }
                                                                    ]
                                                                }).showAt(event.getXY());
                                                                return false;
                                                           },
                                                       }
                                                   }

                                               ]
                                          },{
                                               xtype: 'tabpanel',
                                               title: 'Propery',
                                               region: 'south',
                                               height: 400,
                                               items:[{
                                                    title: 'Tag Property',
                                                    items:[
                                                        {
                                                          xtype : 'textfield',
                                                          title : ' ',
                                                          height: 20,
                                                           width: '100%',
                                                             id : 'foundTagProperty',
                                                           emptyText: 'Найти атрибут тэга',
                                                           listeners: {
                                                                specialkey: function(f,e){
                                                                   if (e.getKey() == e.ENTER) {
                                                                      viewPropertyInfo(selectElement);
                                                                   }
                                                                }
                                                            }
                                                        },
                                                        {
                                                          xtype: 'panel',
                                                          id: 'tabTagProperty',
                                                          width: "100%",
                                                          height: 300,
                                                          html: 'Список свойств propertyVariant'
                                                        }
                                                    ]
                                                },{
                                                      title: 'Tag Property',
                                                      items:[
                                                            {
                                                              xtype : 'textfield',
                                                              title : ' ',
                                                              height: 20,
                                                               width: '100%',
                                                                 id : 'foundProperty',
                                                              emptyText: 'Найти свойство HTML'
                                                            },
                                                            {
                                                              id :'tabProperty',
                                                              width: "100%",
                                                              height: 300,
                                                              xtype: 'panel',
                                                              html: 'Список свойств HTML Attribut'
                                                            }
                                                      ]
                                                },{
                                                    title: 'Style',
                                                    items:[
                                                            {
                                                              xtype : 'textfield',
                                                              title : ' ',
                                                              height: 20,
                                                              emptyText: 'Найти стиль',
                                                               width: '100%',
                                                                 id : 'foundStyle'
                                                            },
                                                            {
                                                              id :'tabStyle',
                                                              width: "100%",
                                                              height: 300,
                                                              xtype: 'panel',
                                                              html: 'Список свойств HTML Style'
                                                            }
                                                      ]
                                                },{
                                                    title: 'Event',
                                                    items:[
                                                            {
                                                              xtype : 'textfield',
                                                              title : ' ',
                                                              emptyText: 'Найти событие',
                                                              height: 20,
                                                               width: '100%',
                                                                 id : 'foundEvent'
                                                            },
                                                            {
                                                              id :'tabEvent',
                                                              width: "100%",
                                                              height: 300,
                                                              xtype: 'panel',
                                                              html: 'Список свойств HTML Event'
                                                            }
                                                    ]
                                                }],
                                           }
                                         ]
                            },{
                                xtype: 'panel',
                                title: 'Element list',
                                html: 'Правая панель',
                                region: 'east',
                                width: 200,
                                split: true,
                                items:[
                                      {
                                          region: 'north',
                                           width: 3500,
                                           xtype: 'textfield',
                                            id: 'filterElementListView',
                                           name: 'name',
                                           listeners: {
                                               specialkey: function(f,e){
                                                  if (e.getKey() == e.ENTER) {
                                                     var filterDomTreeView = Ext.getCmp('filterElementListView');
                                                     var ElementListView = Ext.getCmp('ElementListView');
                                                     var srctxt = filterDomTreeView.value.toLowerCase();
                                                     Ext.getCmp('ElementListView').store.filterBy(function(rec) {
                                                          if (srctxt.length == 0 ) return true;
                                                          if (rec.data.text.toLowerCase().indexOf(srctxt) != -1) {
                                                              var record = elementListTreeStory.getNodeById(rec.data.id);
                                                              ElementListView.getSelectionModel().select(record)
                                                              var path = record.getPath();
                                                              ElementListView.expandPath(path);
                                                              return true;
                                                          }
                                                          return true;
                                                     });

                                                  }
                                               }
                                           }
                                      },
                                      {
                                          region: 'north',
                                          width: 200,
                                          height: 4000,
                                          split: true,
                                          xtype: 'treepanel',
                                          autoScroll: true,
                                          split: true,
                                          rootVisible: false,
                                          id: 'ElementListView',
                                          store: elementListTreeStory,
                                          /*  root: {text: 'Компоненты',expanded: true,children: componentListJson, }, */
                                          listeners: {
                                               afterrender: function() {
                                                  elementListTreeStory.getRootNode().removeAll();
                                                  elementListTreeStory.setRootNode({ "text": "Root", "expanded": true, "children":componentListJson});
                                               },
                                              itemclick : function(tree, record, item, index, e, options) {
                                                  // var cloneItem = record.data.slice()
                                                  var tagName = record.data.tagName;
                                                  console.log(record.data);
                                                  // ElementID
                                                  if (!tagName) {return;}
                                                  NewObjectElement = ContentEditorDocume.document.createElement( tagName );
                                                  if (record.data.style) {
                                                     for (var key in record.data.style) {
                                                         NewObjectElement.style[key] = record.data.style[key];
                                                     }
                                                  }
                                                  if(record.data.class){
                                                     for(var key in record.data.class){
                                                         NewObjectElement.classList.add( record.data.class[key]);
                                                     }
                                                  }
                                                  if(record.data.property){
                                                     for(var key in record.data.property){
                                                         NewObjectElement.setAttribute(key, record.data.property[key]);
                                                     }
                                                  }
                                                  if (record.data.innerHTML){
                                                      NewObjectElement.innerHTML=record.data.innerHTML;
                                                  }
                                                  if (record.data.staticID){
                                                      NewObjectElement.id = record.data.staticID;
                                                  }
                                                  if (record.data.propertyVariant){
                                                      for(var key in record.data.propertyVariant){
                                                         if (key == "name") {
                                                             NewObjectElement.setAttribute("name", record.data.text+getRandomInt(999999));
                                                         }
                                                      }
                                                  }
                                                  // --------------------------------------------------
                                                  // for(var key in record.data){
                                                  //    NewObjectElement.setAttribute(key, record.data[key]);
                                                  // }
                                                  // --------------------------------------------------
                                                  if (record.data.caption) {
                                                     NewObjectElement.setAttribute("caption",record.data.caption);
                                                  }
                                                  if (record.data.value) {
                                                     NewObjectElement.setAttribute("value",record.data.value);
                                                  }

                                                  console.log("NewObjectElement",NewObjectElement);
                                              }
                                          }
                                      }
                                   ]
                            }] ,
                        //renderTo: Ext.getBody()
                        renderTo: document.getElementById('editorId')
                    });


                    //----------------------------------------------------------------------------------------
                    // loadScript("lib/main.js").then(function(){ },function(error){ console.log(error); });
                    //
                    // window.parent.loadScript("component.js").then(function(){ },function(error){ console.log(error); });
                    //----------------------------------------------------------------------------------------
                    var ReadHtmlElementId = 0;
                    var ReadHtmlElement = function(elems,arr) {
                        if (('' + elems) == '[object HTMLBRElement]') {
                            return;
                        } // пропускаем <br/>
                        if ((''+elems.tagName) === 'undefined') {
                               return;
                        } // пропускаем  неизвестные тэги
                        if (elems.getAttribute("DeletTag") != null){
                            return;
                        } // пропускаем тэг с атрибутом DeletTag
                        var sub = {};
                        if (elems.tagName!='HTML'){
                           ReadHtmlElementId++;
                           sub["id"] = "ThreeIdElement_" + ReadHtmlElementId;
                        }
                        sub["text"] = '' + elems['tagName'];
                        if (typeof elems.getAttribute === 'function'){
                           if (elems.getAttribute("cmptype") != null){
                              sub["text"]+=" ("+elems.getAttribute("cmptype")+")";
                           }
                        }
                        sub["ObjectElement"] = elems;
                        arr.push(sub);
                        // обработка детей
                        if ((elems.childNodes)&&(elems.childNodes.length >0 )){
                            sub["children"] = [];
                            for(var i = 0; i < elems.childNodes.length; i++) {
                                var SubElemt = elems.childNodes[i]
                                ReadHtmlElement(SubElemt, sub["children"]);
                            }
                        }
                    }
                    var getDOMtree = function() {
                        TmpElementSrc=ContentEditorDocume.document.getElementsByTagName('html')[0]
                        var obj={};
                        var res = { text: 'DOM', expanded: true, children:[] };
                        ReadHtmlElement (TmpElementSrc ,res.children)
                        return res;
                    }

              var ContentEditorDocume = null;
              var ContentEditorDocumeIframe = document.getElementById('TabBody');
              var NewObjectElement = null;
              var selectElement = null;
              var clickElement  = null;
              var TmpElementSrc = null;
              var TmpElementSrc = null;
              ContentEditorDocumeIframe.src = "";
              ContentEditorDocumeIframe.setAttribute("scrolling", "no");

       //     selectElement=ContentEditorDocume.document.getElementsByTagName('BODY')[0];
              ContentEditorDocumeIframe.onload = function () {
                  ContentEditorDocume = (ContentEditorDocumeIframe.contentWindow) ? ContentEditorDocumeIframe.contentWindow : (ContentEditorDocumeIframe.contentDocument.document) ? ContentEditorDocumeIframe.contentDocument.document : ContentEditorDocumeIframe.contentDocument;
                  ContentEditorDocume.document.designMode = 'off';
                  // ContentEditorDocume.document.write(   getTextUrl('report.html') +  getTextUrl('contextmenu.html') );
                  ContentEditorDocume.document.write(   getTextUrl('report.html') );
                    if (ContentEditorDocume.document.addEventListener) {
                        ContentEditorDocume.document.addEventListener('contextmenu', function(event) {
                            // console.log("event",event);
                            event.preventDefault();
                        }, false);
                    } else {
                        ContentEditorDocume.document.attachEvent('oncontextmenu', function() {
                            console.log("e", e );
                            window.event.returnValue = false;
                        });
                    }
                  window.loadScriptIframe("component.js",3000,ContentEditorDocume).then(function(){ },function(error){ console.log(error); });
                  window.loadCSSIFrame("component.css",3000,ContentEditorDocume).then(function(){ },function(error){ console.log(error); });
                  TmpElementSrc=ContentEditorDocume.document.getElementsByTagName('html')[0];
                  var elementsSrc = TmpElementSrc.querySelectorAll('*');
                  body = elementsSrc;
                  for (var i = 0; i < body.length; i++) {
                      if ( !body[i].getAttribute("DeletTag")){
                         InitAttributesObject(body[i]);
                      }
                  }
                  domHTMLTreeStory.getRootNode().removeAll();
                  domHTMLTreeStory.setRootNode(getDOMtree());
              }
              var LoadWebForm = function() {
                       newWin = window.open('editWin.html', 'example', 'location=1,status=1,scrollbars=1,width=800,height=600,left=320,top=240');
                       newWin.onload = function() {
                          var textEdit =  newWin.document.getElementById("contentText");
                          newWin.document.getElementById("btnSave").onclick = function(){
                              var bodyText = newWin.document.getElementById("contentText").value;
                                  bodyText = bodyText.replaceAll('cmpActionVar', toWorldsCase("cmpActionVar") );
                                  bodyText = bodyText.replaceAll('cmpAction', toWorldsCase('cmpAction'));
                                  bodyText = bodyText.replaceAll('cmpDataSetVar',toWorldsCase('cmpDataSetVar'));
                                  bodyText = bodyText.replaceAll('cmpDataSet',toWorldsCase('cmpDataSet'));
                                  bodyText = bodyText.replaceAll('cmpButton',toWorldsCase('cmpButton'));
                                  bodyText = bodyText.replaceAll('cmpLabel', toWorldsCase('cmpLabel'));
                                  bodyText = bodyText.replaceAll('cmpScript', toWorldsCase('cmpScript'));
                                  bodyText = bodyText.replaceAll('cmpEdit', toWorldsCase('cmpEdit'));
                                  bodyText = bodyText.replaceAll('cmpUnitEdit', toWorldsCase('cmpUnitEdit'));
                                  bodyText = bodyText.replaceAll('cmpDateEdit', toWorldsCase('cmpDateEdit'));
                                  bodyText = bodyText.replaceAll('cmpTextArea', toWorldsCase('cmpTextArea'));
                                  bodyText = bodyText.replaceAll('cmpScript', toWorldsCase('cmpScript'));
                                  bodyText = bodyText.replaceAll('cmpComboBox', toWorldsCase('cmpComboBox'));
                                  bodyText = bodyText.replaceAll('cmpComboItem', toWorldsCase('cmpComboItem'));
                                  bodyText = bodyText.replaceAll('cmpDependences', toWorldsCase('cmpDependences'));
                                  console.log(bodyText);
                              var parser = new DOMParser();
                              var xmlDoc = parser.parseFromString(bodyText, "text/xml");
                              // var xmlDoc = parser.parseFromString(bodyText,  "text/html");
                              x = xmlDoc.documentElement;
                              domList = xmlDoc.querySelectorAll('*')
                              /*
                              for(var ind in domList){
                                 if ( (domList[ind].getAttribute)&&(domList[ind].getAttribute("caption") != null) ) {
                                     if (domList[ind].tagName == 'DIV') continue;
                                     domList[ind].textContent = domList[ind].getAttribute("caption");
                                     domList[ind].removeAttribute("caption");
                                 }
                                 if ((domList[ind].tagName!=='indefined') && (tagInfoList[domList[ind].tagName])){
                                        if (tagInfoList[domList[ind].tagName].class){
                                           for (var subind in  tagInfoList[domList[ind].tagName].class){
                                              var className = tagInfoList[domList[ind].tagName].class[subind];
                                              domList[ind].classList.add(className);
                                           }
                                        }
                                         console.log("domList[ind].tagName",domList[ind].tagName);
                                         console.log(tagInfoList[domList[ind].tagName]);
                                 }
                              }
                              */
                              selectElement=ContentEditorDocume.document.getElementsByTagName('BODY')[0];
                              selectElement.outerHTML = new XMLSerializer().serializeToString(xmlDoc.documentElement);

                              // перестроить дом дерево
                              domHTMLTreeStory.getRootNode().removeAll();
                              domHTMLTreeStory.setRootNode(getDOMtree());
                              var domTreeView = Ext.getCmp('domTreeView');
                              var startNode = domTreeView.getRootNode();
                              startNode.cascadeBy(function (childNode) {
                                 if (childNode.get('ObjectElement') == selectElement) {
                                    var record = domHTMLTreeStory.getNodeById(childNode.id);
                                    domTreeView.getSelectionModel().select(record);
                                    var path = record.getPath();
                                    domTreeView.expandPath(path);
                                 }
                              }, this); // 1

                              newWin.close();
                          };
                          newWin.document.onkeydown = function( event ) {
                              if ( event.keyCode == 27 ) {
                                     newWin.close();
                              }
                          };
                       }
              }
              var saveWebForm = function() {
                  TmpElement = ContentEditorDocume.document.getElementsByTagName('html')[0].cloneNode(true);
                  clearSystemTagFromEditContent(TmpElement,"innrToCaption");
                  var bodyText= TmpElement.outerHTML;
                  bodyText = bodyText.replaceAll('style="position: absolute; top: 0px; left: 0px;"', '');
                  bodyText = bodyText.replaceAll('class="selectElement"', '');
                  bodyText = bodyText.replaceAll('.selectElement{', '.select-lement{');
                  bodyText = bodyText.replaceAll('selectElement', '');
                  bodyText = bodyText.replaceAll('.select-lement{', '.selectElement{');
                  bodyText = bodyText.replaceAll('class=""', '');
                  bodyText = bodyText.replaceAll('style=""', '');
                  bodyText = bodyText.replaceAll('<body><div', '<body>\r<div');
                  bodyText = bodyText.replaceAll('</head><body>', '</head>\r<body>');
                  bodyText = bodyText.replaceAll('      </body>', '</body>');
                  // --------------------------------------------------
                  bodyText = bodyText.replaceAll('cmp-action-var', toCamelCase('cmp-action-var') );
                  bodyText = bodyText.replaceAll('cmp-action', toCamelCase('cmp-action'));
                  bodyText = bodyText.replaceAll('cmp-data-set-var',toCamelCase('cmp-data-set-var'));
                  bodyText = bodyText.replaceAll('cmp-data-set',toCamelCase('cmp-data-set'));
                  bodyText = bodyText.replaceAll('cmp-button',toCamelCase('cmp-button'));
                  bodyText = bodyText.replaceAll('cmp-label', toCamelCase('cmp-label'));
                  bodyText = bodyText.replaceAll('cmp-script', toCamelCase('cmp-script'));
                  bodyText = bodyText.replaceAll('cmp-edit', toCamelCase('cmp-edit'));
                  bodyText = bodyText.replaceAll('cmp-unit-edit', toCamelCase('cmp-unit-edit'));
                  bodyText = bodyText.replaceAll('cmp-date-edit', toCamelCase('cmp-date-edit'));
                  bodyText = bodyText.replaceAll('cmp-text-area', toCamelCase('cmp-text-area'));
                  bodyText = bodyText.replaceAll('cmp-dependences', toCamelCase('cmp-dependences'));
                  bodyText = bodyText.replaceAll('cmp-combo-box', toCamelCase('cmp-combo-box'));
                  bodyText = bodyText.replaceAll('cmp-combo-item', toCamelCase('cmp-combo-item'));

                  // --------------------------------------------------
                  bodyText = bodyText.replaceAll('></cmpDataSetVar>', '/>');
                  bodyText = bodyText.replaceAll('></cmpActionVar>', '/>');
                  bodyText = bodyText.replaceAll('></cmpLabel>', '/>');
                  bodyText = bodyText.replaceAll('></cmpButton>', '/>');
                  // --------------------------------------------------
                  bodyText = bodyText.replaceAll('<br>', '<br/>');
                  // TmpElement.outerHTML = bodyText;
                  // TmpElement.innerHTML = bodyText;
                  // var bodyText = TmpElement.innerHTML
                  console.log(bodyText);
                  copyToClipboard(bodyText);
              }

              var insertElement = function(event) {
                   clickElement = event.toElement;
                   var keyTag = event.toElement.tagName.toLowerCase();
                   if (event.toElement.getAttribute("cmptype")){
                      keyTag+="-"+event.toElement.getAttribute("cmptype");
                   }
                   selectElement = clickElement;
                   if ((event.button == 0 ) && (NewObjectElement !== null)) {
                      if (testParentTag(selectElement, NewObjectElement ) == false){
                        // alert('Нельзя добавить '+NewObjectElement.tagName+' в родителя '+selectElement.tagName)
                        Ext.Msg.alert('Error!', 'Нельзя добавить '+toCamelCase(NewObjectElement.tagName.toLowerCase())+' в родителя '+ toCamelCase(selectElement.tagName.toLowerCase()));
                        NewObjectElement = null;
                        return;
                      }
                      if (NewObjectElement.style.position == "absolute"){
                        NewObjectElement.style.left = event.layerX;
                        NewObjectElement.style.top = event.layerY-8;
                      }
                      clickElement.appendChild(NewObjectElement);
                      selectElement = NewObjectElement;
                      viewPropertyInfo(selectElement); // показать свойства выбранного элемента
                      NewObjectElement = null;
                      // перестроить DOM дерево
                      domHTMLTreeStory.getRootNode().removeAll();
                      domHTMLTreeStory.setRootNode(getDOMtree());
                      var domTreeView = Ext.getCmp('domTreeView');
                      var startNode = domTreeView.getRootNode();
                      startNode.cascadeBy(function (childNode) {
                            if (childNode.get('ObjectElement') == selectElement) {
                               var record = domHTMLTreeStory.getNodeById(childNode.id);
                               domTreeView.getSelectionModel().select(record)
                            }
                       }, this); //2
                      return;
                   }
                   if ( event.button == 0 ) {
                       if ( TmpElementSrc.getAttribute("DeletTag")){
                           return;
                       }
                       var elementsSrc = TmpElementSrc.querySelectorAll('*');
                       for (var i = 0; i < elementsSrc.length; i++) {
                          if (elementsSrc[i].classList.contains('selectElement')) {
                              elementsSrc[i].classList.remove("selectElement");
                          }
                       }
                       clickElement.classList.add("selectElement");
                       // Выделить элемент в дом дереве
                       var domTreeView = Ext.getCmp('domTreeView');
                       var startNode = domTreeView.getRootNode();
                       startNode.cascadeBy(function (childNode) {
                            if (childNode.get('ObjectElement') == selectElement) {
                               var record = domHTMLTreeStory.getNodeById(childNode.id);
                               domTreeView.getSelectionModel().select(record)
                               var path = record.getPath();
                               domTreeView.expandPath(path);
                            }
                       }, this);//4
                   }
              }

              var keyEvent = function(event) {
                  //console.log(event.keyCode);
                  if (event.keyCode == 27) { //esc
                        console.log('ESC');
                  }
                  if (event.keyCode == 46) { //del
                      console.log('DEL')
                      if ((ContentEditorDocume.document.designMode != 'on' )
                          && (selectElement!=null)
                          && (selectElement.tagName!="BODY")
                         ) {
                         var parentEl = selectElement.parentElement;
                         selectElement.remove();
                         selectElement = parentEl;
                         domHTMLTreeStory.getRootNode().removeAll();
                         domHTMLTreeStory.setRootNode(getDOMtree());
                      }
                  }
                 //-------------------------------------------
                 if ((event.keyCode == 37) && (event.ctrlKey==true)&&(selectElement!=null)) { //лево
                     var left = parseInt( selectElement.style.left );
                     left-=1;
                     selectElement.style.left =left+'px';
                     return;
                  }
                  if ((event.keyCode == 39)&&(event.ctrlKey==true)&&(selectElement!=null)) { //права
                     var left = parseInt( selectElement.style.left );
                     left+=1;
                     selectElement.style.left =left+'px';
                     return;
                  }
                  if ((event.keyCode == 38)&&(event.ctrlKey==true)&&(selectElement!=null)) { //верх
                     var top = parseInt( selectElement.style.top );
                     top-=1;
                     selectElement.style.top =top+'px';
                     return;
                  }
                  if ((event.keyCode == 40)&&(event.ctrlKey==true)&&(selectElement!=null)) { //низ
                     var top = parseInt( selectElement.style.top );
                     top+=1;
                     selectElement.style.top =top+'px';
                     return;
                  }
                //-------------------------------------------
                  if ((event.keyCode == 37)&&(event.shiftKey==false)&&(selectElement!=null)) { //лево
                     var left = parseInt( selectElement.style.left );
                     left-=10;
                     selectElement.style.left =left+'px';
                  }
                  if ((event.keyCode == 39)&&(event.shiftKey==false)&&(selectElement!=null)) { //права
                     var left = parseInt( selectElement.style.left );
                     left+=10;
                     selectElement.style.left =left+'px';
                  }

                  if ((event.keyCode == 38)&&(event.shiftKey==false)&&(selectElement!=null)) { //верх
                     var top = parseInt( selectElement.style.top );
                     top-=10;
                     selectElement.style.top =top+'px';
                  }
                  if ((event.keyCode == 40)&&(event.shiftKey==false)&&(selectElement!=null)) { //низ
                     var top = parseInt( selectElement.style.top );
                     top+=10;
                     selectElement.style.top =top+'px';
                  }
                  //----------------------------------
                  if ((event.keyCode == 37)&&(event.shiftKey==true)&&(selectElement!=null)) { //лево
                     var width = parseInt( selectElement.style.width);
                     width-=1;
                     selectElement.style.width = width+'px';
                  }
                  if ((event.keyCode == 39)&&(event.shiftKey==true)&&(selectElement!=null)) { //права
                     var width = parseInt( selectElement.style.width );
                     width+=1;
                     selectElement.style.width =width+'px';
                  }
                  if ((event.keyCode == 38)&&(event.shiftKey==true)&&(selectElement!=null)) { //верх
                     var height = parseInt( selectElement.style.height );
                     height-=1;
                     selectElement.style.height =height+'px';
                  }
                  if ((event.keyCode == 40)&&(event.shiftKey==true)&&(selectElement!=null)) { //низ
                     var height = parseInt( selectElement.style.height );
                     height+=1;
                     selectElement.style.height = height+'px';
                  }
                  //---------------------------------------
                  // for (var property in event) {
                  //    console.log(property+" : "+event[property]);
                  // }
              }

              var InitAttributesObject = function (ObjectElement) {
                  ObjectElement.removeEventListener("mousedown", insertElement);
                  ObjectElement.addEventListener("mousedown", insertElement, false);
                  ObjectElement.removeEventListener("keydown", keyEvent);
                  ObjectElement.addEventListener('keydown', keyEvent, false );
                  ObjectElement.removeEventListener("dblclick", dblClickElement);
                  ObjectElement.addEventListener('dblclick', dblClickElement, false );
              }

              var newWin = null;
              var dblClickElement = function(event) {
                    if (selectElement!=null) {
                              newWin = window.open('editWin.html', 'example', 'location=1,status=1,scrollbars=1,width=600,height=400,left=320,top=240');
                              newWin.onload = function() {
                                  var textEdit =  newWin.document.getElementById("contentText");
                                  var TmpSelectElement = selectElement.cloneNode(true);
                                  // clearSystemTagFromEditContent(TmpSelectElement);
                                  textEdit.innerHTML = clearSystemTextFromEditContent(TmpSelectElement.outerHTML);
                                  newWin.document.getElementById("btnSave").onclick = function(){
                                       // var infoComponent = selectElement.getAttribute("delettag_build_element_tree_id");
                                       selectElement.outerHTML = newWin.document.getElementById("contentText").value;
                                       newWin.close();
                                  };
                                 newWin.document.onkeydown = function( event ) {
                                      if ( event.keyCode == 27 ) {
                                          newWin.close();
                                      }
                                  };
                              }
                    }
              }
              var clearSystemTextFromEditContent = function(bodyText){
                  bodyText = bodyText.replaceAll('style="position: absolute; top: 0px; left: 0px;"', '');
                  bodyText = bodyText.replaceAll('class="selectElement"', '');
                  bodyText = bodyText.replaceAll('.selectElement{', '.select-lement{');
                  bodyText = bodyText.replaceAll('selectElement', '');
                  bodyText = bodyText.replaceAll('.select-lement{', '.selectElement{');
                  bodyText = bodyText.replaceAll('class=""', '');
                  bodyText = bodyText.replaceAll('style=""', '');
                  bodyText = bodyText.replaceAll('<body><div', '<body>\r<div');
                  bodyText = bodyText.replaceAll('</head><body>', '</head>\r<body>');
                  bodyText = bodyText.replaceAll('      </body>', '</body>');
                  return bodyText
              }
              var clearSystemTagFromEditContent = function(TmpSelectElement,innrToCaption){
                  var elements = TmpSelectElement.querySelectorAll('*');
                  for (var i = 0; i < elements.length; i++) {
                     for(var ind in elements[i].classList) {
                      //  if (typeof elements[i].classList[ind] === 'function') continue;
                        var txt = ""+elements[i].classList[ind];
                        if ((txt.indexOf('M2_WebBuilder_') !== -1)
                         || (txt.indexOf('D3_WebBuilder_') !== -1)
                         || (txt.indexOf('selectElement') !== -1)
                         ) {
                           elements[i].classList.remove(elements[i].classList[ind]);
                        }
                     }
                     // информация о компоненте
                     var keyTag =  elements[i].tagName.toLowerCase();
                     if ( elements[i].getAttribute("cmptype")){
                        keyTag+="-"+ elements[i].getAttribute("cmptype");
                     }
                     if (tagInfoList[keyTag]){
                        if ((tagInfoList[keyTag].innerHtmlToCaption) && (tagInfoList[keyTag].innerHtmlToCaption == true)) {
                            elements[i].setAttribute("caption", elements[i].innerHTML);
                            elements[i].innerHTML = "";
                        }
                     }
                     if (elements[i].getAttribute){
                        if (elements[i].getAttribute("delettag")) elements[i].remove();
                        if (elements[i].getAttribute("delettag_build_element_tree_id"))elements[i].removeAttribute("delettag_build_element_tree_id");
                     }
                     /*
                     for(var key in elements[i]) {
                        if (typeof elements[i][key] === 'function') continue;
                        // if (typeof elements[i][key] === 'null') continue;
                        // if (elements[i][key] == 'null') continue;
                        console.log(typeof elements[i][key], ind,elements[i][key])
                        if ( key === 'children') continue;
                        if ( key === 'childNodes') continue;
                        if ( key === 'lastChild') continue;
                        if ( key === 'firstChild ') continue;
                        if ( key === 'parentNode') continue;
                        if ( key === 'parentElement') continue;
                        if ( key === 'ownerDocument') continue;
                        if ( key === 'attributeStyleMap') continue;
                        if ( key === 'outerHTML') continue;
                        if ( key === 'innerHTML') continue;
                        if ( key === 'part') continue;
                        //if ( key === 'toString') continue;
                        //if ( key === 'classList') continue;
                        if ( key === 'attributes') continue; // список добавленых пользовательских атребут
                        // console.log("elements[i][key]",""+ind,elements[i][key])
                        // if ((txt.indexOf('M2_WebBuilder_') !== -1) || (txt.indexOf('D3_WebBuilder_') !== -1)) {
                        //   elements[i].removeAttribute(key);
                        // }
                     }
                     */
                  }
                  var bodyText= TmpSelectElement.outerHTML;
                  //console.log(TmpSelectElement.outerHTML);
                  bodyText = bodyText.replaceAll('style="position: absolute; top: 0px; left: 0px;"', '');
                  bodyText = bodyText.replaceAll('class="selectElement"', '');
                  bodyText = bodyText.replaceAll('.selectElement{', '.select-lement{');
                  bodyText = bodyText.replaceAll('selectElement', '');
                  bodyText = bodyText.replaceAll('.select-lement{', '.selectElement{');
                  bodyText = bodyText.replaceAll('class=""', '');
                  bodyText = bodyText.replaceAll('style=""', '');
                  bodyText = bodyText.replaceAll('<body><div', '<body>\r<div');
                  bodyText = bodyText.replaceAll('</head><body>', '</head>\r<body>');
                  bodyText = bodyText.replaceAll('      </body>', '</body>');
                  if (innrToCaption) {
                     bodyText = bodyText.replaceAll('cmp-action-var', 'cmpActionVar');
                     bodyText = bodyText.replaceAll('cmp-action', 'cmpAction');
                     bodyText = bodyText.replaceAll('cmp-data-set-var', 'cmpDataSetVar');
                     bodyText = bodyText.replaceAll('cmp-data-set', 'cmpDataSet');
                     bodyText = bodyText.replaceAll('cmp-label', 'cmpLabel');
                  }
                  elements.outerHTML = bodyText;
                  return elements;
              }

              window.contextMenuExec=function(btn) {
                  console.log("contextMenuExec",btn);
              }

             window.iframe_Designer_On_Off = function() {
                 if (ContentEditorDocume.document.designMode == 'on' ){
                       ContentEditorDocume.document.designMode = 'off'
                 } else {
                       ContentEditorDocume.document.designMode = 'on'
                 }
             }
             window.iframe_Scroll_On_Off = function() {
                 if ( ContentEditorDocumeIframe.getAttribute("scrolling")){
                     ContentEditorDocumeIframe.removeAttribute("scrolling");
                 } else {
                     ContentEditorDocumeIframe.setAttribute("scrolling", "no");
                 }
             }
             window.contextMenuSetFontSize=function(btn) {
                if (selectElement != null ){
                    console.log("contextMenuExec",btn.innerHTML);
                    console.log("selectElement",selectElement);
                    selectElement.style.fontSize = btn.innerHTML;
                }
             }

             testParentTag = function(selectElement, NewObjectElement ){
                  // информация о компоненте
                  var keyTag =  NewObjectElement.tagName.toLowerCase();
                  var parentTag =  selectElement.tagName.toLowerCase();

                  if (( NewObjectElement.getAttribute("cmptype"))&&(NewObjectElement.getAttribute("cmptype")!=='tmp')){
                      keyTag+="-"+ NewObjectElement.getAttribute("cmptype");
                  }
                  if (tagInfoList[keyTag]){
                     if (tagInfoList[keyTag].parentTag) {
                         var resultTest = false;
                         for ( var ind in tagInfoList[keyTag].parentTag) {
                            if ( tagInfoList[keyTag].parentTag[ind] == parentTag ){
                               resultTest = true;
                            }
                         }
                         return resultTest;
                     }
                  }
                return true;
             }

              changeElementVal = function( el ){  // функция изменения  свойства элемента
                 var nam = el.getAttribute("propname");
                 if (el.value === 'null'){
                    selectElement.removeAttribute(nam);
                 }else{
                    selectElement.setAttribute(nam,el.value);
                    // try {
                    //    selectElement[nam] = el.value;
                    // } catch {
                    //    selectElement.setAttribute(nam,el.value);
                    // }
                 }
              }

             // Прочитать список свойств  выбранного элемента
             viewPropertyInfo = function(selectElement) {
                 var keyTag = selectElement.tagName.toLowerCase();
                 if (( selectElement.getAttribute("cmptype")) && (selectElement.getAttribute("cmptype")!=='tmp')){
                      keyTag+="-"+ selectElement.getAttribute("cmptype");
                 }
                 if ((tagInfoList[keyTag]) && (tagInfoList[keyTag].propertyVariant)) {
                     var foundTagProperty = Ext.getCmp('foundTagProperty');
                     var srctxt = foundTagProperty.value.toLowerCase();
                     var tabTagProperty = Ext.getCmp('tabTagProperty');
                     var opt = [];
                     opt.push("<table>");
                     for( var ind in tagInfoList[keyTag].propertyVariant){
                        if (srctxt.length > 0 ) {
                           if (ind.toLowerCase().indexOf(srctxt) == -1) continue;
                        }
                        var typ = tagInfoList[keyTag].propertyVariant[ind]
                        var val = selectElement.getAttribute(ind)
                        opt.push("<tr><td>");
                        opt.push(ind);
                        opt.push("</td>");
                        opt.push("<td>");
                        if (typ == "string") {
                           opt.push(`  <input propname="${ind}" value="${val}" onchange="changeElementVal(this)" type="text" />`);
                        } else if (typ == "number") {
                           opt.push(`  <input propname="${ind}" value="${val}" onchange="changeElementVal(this)" type="number" />`);
                        }else if (typeof typ === "object") {
                           opt.push(`<datalist id="LIST-${ind}" value="${val}">`);
                           for(var subInd in typ) {
                              opt.push(`<option value="${typ[subInd]}" />`);
                           }
                           opt.push(`</datalist>`);
                           opt.push(`<input list="LIST-${ind}" style='width:80%'  id="EditProperty${ind}" propname="${ind}" value="${val}" onchange="changeElementVal(this)" type="text"  /><button onclick=" document.getElementById('EditProperty${ind}').value='';  ">X</button> `);
                        }
                        opt.push("</td>");
                        opt.push("</tr>");
                     }
                     opt.push("</table>");
                     tabTagProperty.ariaEl.dom.innerHTML = opt.join("");
                }
             }
          });
    </script>
</head>
<body>
<div id="editorId" style="width:100%;height100%;position:absolute;"></div>
</body>
</html>